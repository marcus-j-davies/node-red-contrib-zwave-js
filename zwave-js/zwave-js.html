
<script src="zwave-js/client.js"></script>
<link rel="stylesheet" href="zwave-js/styles.css">
<script type="text/javascript">

    RED.nodes.registerType('zwave-js',
        {
            category: 'ZWave JS',
            color: 'rgb(46,145,205)',
            defaults:
            {
                serialPort: { value: undefined },
                name: { value: "Z-Wave JS Controller" },
                encryptionKey : {value:undefined},
                ackTimeout:{value:undefined},
                controllerTimeout:{value:undefined},
                sendResponseTimeout:{value:undefined},
                logLevel:{value:"none"},
                logFile:{value:undefined},
                logNodeFilter:{value:undefined},
                sendUsageStatistics:{value:true}
            },
            inputs: 1,
            outputs: 1,
            icon: "ZWAVE.png",
            label: function () {
                return this.name;
            },
            onpaletteadd:ZwaveJsUI.init,
            oneditprepare:SortUI
        });


    function SortUI() {
        
            $.getJSON("zwjsgetports",(data) => {

                $("#node-input-serialPort").empty()
                $("#node-input-serialPort").append(new Option("Select Port", "Select Port"));
                $("#node-input-serialPort").append(new Option("Custom Path...", "Custom Path..."));

                $("#node-input-serialPort").append(
                    data.map(function (option) {
                        return new Option(option, option);
                    })
                )

                if (this.serialPort !== undefined) {

                    if(data.indexOf(this.serialPort) < 0){
                        $("#node-input-serialPort").append(new Option(this.serialPort, this.serialPort));
                    }

                    $("#node-input-serialPort").val(this.serialPort)

                } else {
                    $("#node-input-serialPort").val("Select Port")
                }

                $("#node-input-serialPort").change(function (event){

                    var Value = event.target.value;

                     if(Value === "Custom Path..."){

                         Value = prompt("Enter custom serial path.")
                         if(Value !== null){
                            Value = Value.trim()
                            $("#node-input-serialPort").append(new Option(Value, Value));
                            $("#node-input-serialPort").val(Value)
                         }
                     }
                });
            });

            $.getJSON("zwjsgetversion", function (data) {
                $("#MOD_Version").val(data.moduleversion)
                $("#ZWJS_Version").val(data.zwjsversion)
            })
        }



</script>

<script type="text/x-red" data-template-name="zwave-js">

    <p>
        <strong>Z-Wave JS Usage Reporting.</strong><br />
        Sending usage reports, is anonymous, and no personal or identifiable information is included. Read the statement <a target="_blank" href="https://zwave-js.github.io/node-zwave-js/#/getting-started/telemetry?id=usage-statistics">[Here]</a>.<br />
        The information is used to improve Z-Wave JS and determines where focus of the library should be.
    </p>
    <div class="form-row">
        <label  for="node-input-sendUsageStatistics" style="width:130px"><i class="fa fa-pencil"></i> Send Statistics</label>
        <input type="checkbox" id="node-input-sendUsageStatistics">
    </div>

    <p>
        <strong>Basic settings.</strong>
    </p>
    <div class="form-row">
        <label for="node-input-name" style="width:130px"><i class="fa fa-pencil"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Zwave Controller">
    </div>
    <div class="form-row">
        <label for="node-input-serialPort" style="width:130px"><i class="fa fa-pencil"></i> Serial Port</label>
        <select id="node-input-serialPort">
        </select>

    </div>
    <div class="form-row">
        <label for="node-input-encryptionKey" style="width:130px"><i class="fa fa-pencil"></i> Encryption Key</label>
        <input type="text" id="node-input-encryptionKey" placeholder="[0x01,0x02,..] or string">
    </div>
    <br />
    <p>
        <strong>Timeouts (ms).</strong>
    </p>
    <div class="form-row">
        <label  for="node-input-ackTimeout" style="width:130px"><i class="fa fa-pencil"></i> ACK</label>
        <input type="text" id="node-input-ackTimeout" placeholder="Use Default">
    </div>
    <div class="form-row">
        <label  for="node-input-controllerTimeout" style="width:130px"><i class="fa fa-pencil"></i> Controller</label>
        <input type="text" id="node-input-controllerTimeout" placeholder="Use Default">
    </div>
    <div class="form-row">
        <label  for="node-input-sendResponseTimeout" style="width:130px"><i class="fa fa-pencil"></i> Req -> Res</label>
        <input type="text" id="node-input-sendResponseTimeout" placeholder="Use Default">
    </div>
    <br />
    <p>
        <strong>Z-Wave JS Logging</strong>
    </p>
    <div class="form-row">
        <label  for="node-input-logLevel" style="width:130px"><i class="fa fa-pencil"></i> Log Level</label>
        <select id="node-input-logLevel">
            <option value="none">Logging Disabled</option>
            <option value="debug">Debug</option>
            <option value="error">Error</option>
            <option value="info">Info</option>
            <option value="silly">Silly</option>
            <option value="verbose">Verbose</option>
            <option value="warn">Warn</option>
        </select>
    </div>
    <div class="form-row">
        <label  for="node-input-logFile" style="width:130px"><i class="fa fa-pencil"></i> Log File</label>
        <input type="text" id="node-input-logFile" placeholder="zwave-js-log.txt">
    </div>
    <div class="form-row">
        <label  for="node-input-logFile" style="width:130px"><i class="fa fa-pencil"></i> Node Filter</label>
        <input type="text" id="node-input-logNodeFilter" placeholder="2,5,24">
    </div>
    <br />
    <p>
        <strong>Version Information.</strong>
    </p>
    <div class="form-row">
        <label  for="MOD_Version" style="width:130px"><i class="fa fa-info"></i> Module Version</label>
        <input type="text" id="MOD_Version" readonly>
    </div>
    <div class="form-row">
        <label  for="ZWJS_Version" style="width:130px"><i class="fa fa-info"></i> Driver Version</label>
        <input type="text" id="ZWJS_Version" readonly>
    </div>
   
</script>

<script type="text/x-red" data-help-name="zwave-js">
    <p>A Z-Wave Controller for node red.</p>

    <p>
        <code>Input:</code><br />
        A <strong>payload</strong> object containing a command to send to a ZWave device.<br />
        <strong>params</strong> will be dependant on the <strong>class</strong> and <strong>operation</strong> being performed.
<pre>
{
   node: 2,
   class: "Configuration",
   operation: "Set",
   params: [0x18,0x03,1]
}
</pre>
    </p>

    <p>
        <code>Output:</code><br />
        A <strong>payload</strong> containing an event that has occured within the zwave network.<br />
        The contents of <strong>object</strong> is dependant on the event.
<pre>
{
   node: 2,
   event: "VALUE_UPDATED",
   timestamp: "23-12-2020T12:23:23+000",
   object: ...
}
</pre>
    </p>


</script>